<template>
    <a-tree v-if="treeData.length"
            checkable
            v-model="checkboxs"
            :treeData="treeData"
            :defaultExpandAll="true"
            :checkStrictly="true"
            @check="onCheck"
    />
</template>

<script>
    export default {
        name: "Tree",
        data: () => ({
            treeData: [],
            checkboxs: [],
        }),
        mounted(){
            let _this = this;

            //异步加载权限
            axios.post('system/develop/permission',{}).then((response) => {
                if(!response.status){
                    return this.$message.error(response.message);
                }
                // for(var i in response.data){
                //     for(var j in response.data[i].children){
                //         response.data[i].children[j].class = 'whiteSpaceNormal'
                //     }
                // }
                _this.treeData = response.data;
            });

        },
        methods: {
            onCheck(selectedKeys, info) {
                let _this = this;
                _this.$nextTick(() => {
                    let status = info.checked,
                        isSelected = selectedKeys.checked,
                        line = this.findLine(this.treeData,info.node.eventKey);

                    this.initLineCheck(this.treeData,line,status,isSelected);
                });
            },
            initLineCheck(data,line,status){
                let sons = this.getSonKey(this.getNodeByLine(data,line));
                let nodePool = this.checkboxs.checked;
                if(status){
                    sons = sons.filter(item => {
                        return !nodePool.includes(item)
                    });
                    nodePool = [...nodePool,...sons];
                }else{
                    nodePool = nodePool.filter(item => {
                        return !sons.includes(item)
                    })
                }
                nodePool = this.parentNode(data,line,nodePool);
                this.checkboxs = nodePool;
            },
            findLine(data,key,line = []){
                for(var i in data){
                    line.push(i);
                    if(data[i].id == key){
                        return line;
                    }
                    if(this.findLine(data[i].children,key,line)){
                        return line;
                    }else{
                        line.pop();
                    }
                }
                return false;
            },
            getNodeByLine(data,line){
                let need = data;
                for (let i in line){
                    need = need[line[i]].children
                }
                return need;
            },
            getSonKey(data,line = []){
                for(var i in data){
                    line.push(data[i].key);
                    this.getSonKey(data[i].children,line)
                }
                return line;
            },
            parentNode(data,line,nodePool){
                line.pop()
                if(!line.length){
                    return nodePool;
                }
                let brothers = this.getNodeByLine(data,line);
                let top = brothers.map(item => {
                        return item.key;
                    }).some(item => {
                        return nodePool.includes(item)
                    });
                let parentKey = brothers[0].parent_id;

                if(top){
                    nodePool = nodePool.includes(parentKey) ? nodePool : [...nodePool,parentKey];
                }else{
                    nodePool = nodePool.filter(item => {
                        return item != parentKey
                    })
                }
                return this.parentNode(data,line,nodePool);
            }
        }
    }
</script>

<style>
    .whiteSpaceNormal>ul{
        white-space: normal !important;
    }
    .whiteSpaceNormal>ul>li{
        display: inline-block;
    }
</style>